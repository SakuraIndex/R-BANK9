name: Auto intraday & close (5min, market-aware)

on:
  workflow_dispatch:
    inputs:
      force_intraday:
        description: "Run intraday even outside session?"
        required: false
        default: "false"
      force_close:
        description: "Run close block once (outside close window)?"
        required: false
        default: "false"
  schedule:
    # 平日5分おき（UTC）— 実行可否はジョブ内でJST判定
    - cron: "*/5 * * * 1-5"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # 手動入力がない（＝schedule）の場合も安全にフラグを用意
      - name: Set force flags from inputs (safe for schedule)
        shell: bash
        env:
          INP_FORCE_INTRADAY: ${{ github.event.inputs.force_intraday || 'false' }}
          INP_FORCE_CLOSE:    ${{ github.event.inputs.force_close    || 'false' }}
        run: |
          set -euo pipefail
          [ "${INP_FORCE_INTRADAY}" = "true" ] && FI=1 || FI=0
          [ "${INP_FORCE_CLOSE}"    = "true" ] && FC=1 || FC=0
          {
            echo "FORCE_INTRADAY=$FI"
            echo "FORCE_CLOSE=$FC"
          } | tee -a "$GITHUB_ENV"

      - name: Resolve repo → index settings
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          REPO_LC="$(echo "${GITHUB_REPOSITORY##*/}" | tr '[:upper:]' '[:lower:]')"
          case "$REPO_LC" in
            r-bank9)
              KEY="rbank9"; TZ="Asia/Tokyo"; S="09:00"; E="15:30"; INTRA="src/rbank9_intraday.py" ;;
            3_sakura_space)
              KEY="astra4"; TZ="Asia/Tokyo"; S="09:00"; E="15:30"; INTRA="src/astra4_intraday.py" ;;
            s-coin-)
              KEY="scoin_plus"; TZ="Asia/Tokyo"; S="09:00"; E="15:30"; INTRA="src/scoin_plus_intraday.py" ;;
            ain-10)
              KEY="ain10"; TZ="America/New_York"; S="09:30"; E="16:00"; INTRA="src/ain10_snapshot.py" ;;
            *)
              echo "Unknown repo: ${GITHUB_REPOSITORY##*/}"; exit 1 ;;
          esac
          {
            echo "INDEX_KEY=$KEY"
            echo "MARKET_TZ=$TZ"
            echo "SESSION_START=$S"
            echo "SESSION_END=$E"
            echo "INTRA_SCRIPT=$INTRA"
          } | tee -a "$GITHUB_ENV"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          pip install -r requirements.txt
          python - <<'PY'
          import sys, platform
          print("=== DIAG ===")
          print("Python:", sys.version.split()[0], "| Platform:", platform.platform())
          PY

      - name: Compute session flags (DST-aware)
        id: flags
        shell: bash
        run: |
          set -euo pipefail
          python - << 'PY'
          from datetime import datetime, time, timedelta
          from zoneinfo import ZoneInfo
          import os
          tz = ZoneInfo(os.environ.get("MARKET_TZ","Asia/Tokyo"))
          s_h, s_m = map(int, os.environ.get("SESSION_START","09:00").split(":"))
          e_h, e_m = map(int, os.environ.get("SESSION_END","15:30").split(":"))
          now   = datetime.now(tz)
          start = datetime.combine(now.date(), time(s_h, s_m), tzinfo=tz)
          end   = datetime.combine(now.date(), time(e_h, e_m), tzinfo=tz)
          if end <= start:
              end += timedelta(days=1)
          in_session = start <= now <= end
          at_close_window = end <= now < end + timedelta(minutes=20)

          # close一度きり実行のガード
          last_flag = ""
          try:
              with open("docs/outputs/_last_run.txt","r",encoding="utf-8") as f:
                  last_flag = f.read().strip()
          except FileNotFoundError:
              pass
          close_key = f"close-{now.date()}"
          already_closed = (last_flag == close_key)

          print(f"[diag] TZ={tz}, now={now}, start={start}, end={end}, in_session={in_session}, at_close={at_close_window}, already_closed={already_closed}")

          with open(os.environ["GITHUB_OUTPUT"], "a") as g:
              g.write(f"in_session={'true' if in_session else 'false'}\n")
              g.write(f"at_close={'true' if at_close_window else 'false'}\n")
              g.write(f"already_closed={'true' if already_closed else 'false'}\n")
              g.write(f"close_key={close_key}\n")
          PY

      - name: Run intraday (every 5 min during session OR forced)
        if: steps.flags.outputs.in_session == 'true' || env.FORCE_INTRADAY == '1'
        env:
          INDEX_KEY: ${{ env.INDEX_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          echo "== intraday (${INDEX_KEY}) =="
          mkdir -p docs/outputs
          python "$INTRA_SCRIPT"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/outputs/*intraday.* 2>/dev/null || true
          git commit -m "chore(intraday): ${INDEX_KEY}" || echo "no intraday changes"
          git push || true

      - name: Run close tasks (once)
        if: (steps.flags.outputs.at_close == 'true' && steps.flags.outputs.already_closed != 'true') || env.FORCE_CLOSE == '1'
        env:
          INDEX_KEY: ${{ env.INDEX_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          echo "== close (${INDEX_KEY}) =="
          mkdir -p docs/outputs
          # 当日分を history に反映（存在すれば）
          if [ -f scripts/update_history.py ]; then
            python scripts/update_history.py || true
          fi
          # 長期チャートと stats
          if [ -f scripts/long_charts.py ]; then
            python scripts/long_charts.py || true
          fi
          # 1日1回フラグ
          echo "${{ steps.flags.outputs.close_key }}" > docs/outputs/_last_run.txt

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/outputs/* 2>/dev/null || true
          git commit -m "chore(close): ${INDEX_KEY} long charts & stats" || echo "no close changes"
          git push || true

      - name: Upload artifacts (debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rbank9-outputs
          path: |
            docs/outputs/*intraday.*
            docs/outputs/*history*
            docs/outputs/*_run.txt
            docs/outputs/*stats*.json
