name: Auto intraday & close (5min, market-aware)

on:
  workflow_dispatch:
    inputs:
      force_intraday:
        description: "Run intraday even outside session?"
        required: false
        default: "false"
      force_close:
        description: "Run close block once (outside close window)?"
        required: false
        default: "false"
  schedule:
    - cron: "*/5 * * * 1-5"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      FORCE_INTRADAY: ${{ github.event.inputs.force_intraday == 'true' && '1' || '0' }}
      FORCE_CLOSE:    ${{ github.event.inputs.force_close    == 'true' && '1' || '0' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0, persist-credentials: true }

      - name: Resolve repo → index settings
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          REPO_LC="$(echo "${GITHUB_REPOSITORY##*/}" | tr '[:upper:]' '[:lower:]')"
          case "$REPO_LC" in
            r-bank9) KEY="rbank9"; TZ="Asia/Tokyo"; S="09:00"; E="15:30"; INTRA="src/rbank9_intraday.py" ;;
            3_sakura_space) KEY="astra4"; TZ="Asia/Tokyo"; S="09:00"; E="15:30"; INTRA="src/astra4_intraday.py" ;;
            s-coin-) KEY="scoin_plus"; TZ="Asia/Tokyo"; S="09:00"; E="15:30"; INTRA="src/scoin_plus_intraday.py" ;;
            ain-10)  KEY="ain10"; TZ="America/New_York"; S="09:30"; E="16:00"; INTRA="src/ain10_snapshot.py" ;;
            *) echo "Unknown repo"; exit 1 ;;
          esac
          {
            echo "INDEX_KEY=$KEY"
            echo "MARKET_TZ=$TZ"
            echo "SESSION_START=$S"
            echo "SESSION_END=$E"
            echo "INTRA_SCRIPT=$INTRA"
          } | tee -a "$GITHUB_ENV"

      - name: Setup Python
        uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install deps
        run: |
          set -euo pipefail
          pip install -U pip
          pip install -r requirements.txt

      - name: Compute session flags (DST-aware)
        id: flags
        shell: bash
        run: |
          set -euo pipefail
          python - << 'PY'
          from datetime import datetime, time, timedelta
          from zoneinfo import ZoneInfo
          import os, sys
          tz = ZoneInfo(os.environ["MARKET_TZ"])
          s_h, s_m = map(int, os.environ["SESSION_START"].split(":"))
          e_h, e_m = map(int, os.environ["SESSION_END"].split(":"))
          now = datetime.now(tz)
          start = datetime.combine(now.date(), time(s_h, s_m, tzinfo=tz))
          end   = datetime.combine(now.date(), time(e_h, e_m, tzinfo=tz))
          if end <= start: end += timedelta(days=1)
          in_session = start <= now <= end
          at_close_window = end <= now < end + timedelta(minutes=20)
          # last close guard
          last_flag = ""
          try:
              with open("docs/outputs/_last_run.txt","r",encoding="utf-8") as f:
                  last_flag = f.read().strip()
          except FileNotFoundError:
              pass
          close_key = f"close-{now.date()}"
          already_closed = (last_flag == close_key)
          with open(os.environ["GITHUB_OUTPUT"],"a") as g:
              g.write(f"in_session={'true' if in_session else 'false'}\n")
              g.write(f"at_close={'true' if at_close_window else 'false'}\n")
              g.write(f"already_closed={'true' if already_closed else 'false'}\n")
              g.write(f"close_key={close_key}\n")
          PY

      # === ここを「強制許可」つきにする ===
      - name: Run intraday (every 5 min during session OR forced)
        if: steps.flags.outputs.in_session == 'true' || env.FORCE_INTRADAY == '1'
        env:
          INDEX_KEY: ${{ env.INDEX_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          echo "== intraday =="
          python "$INTRA_SCRIPT"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/outputs/*intraday.* 2>/dev/null || true
          git commit -m "chore(intraday): ${INDEX_KEY}" || echo "no intraday changes"
          git push || true

      # close も強制実行オプションを追加（任意）
      - name: Run close tasks (once)
        if: (steps.flags.outputs.at_close == 'true' && steps.flags.outputs.already_closed != 'true') || env.FORCE_CLOSE == '1'
        env:
          INDEX_KEY: ${{ env.INDEX_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          python scripts/update_history.py || true
          python scripts/long_charts.py
          echo "${{ steps.flags.outputs.close_key }}" > docs/outputs/_last_run.txt
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/outputs/* 2>/dev/null || true
          git commit -m "chore(close): ${INDEX_KEY} long charts & stats" || echo "no close changes"
          git push || true
