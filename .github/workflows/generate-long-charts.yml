name: Generate long-term charts (R-BANK9)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -r requirements.txt

      - name: List BEFORE
        run: |
          pwd
          ls -lah
          ls -lah docs/outputs || true

      # ① intraday -> history（日次終値へマージ）
      - name: Append daily history from intraday
        run: python scripts/update_history.py

      # ② チャートを生成（1d/7d/1m/1y）
      - name: Generate long-term charts
        env:
          INDEX_KEY: rbank9
        run: python scripts/long_charts.py

      # ③ “必ず差分が出る” テキストを更新（コミット抑止回避）
      - name: Touch last-run marker
        run: |
          mkdir -p docs/outputs
          date +'%Y-%m-%d %H:%M:%S%z' > docs/outputs/_last_run.txt

      - name: List AFTER
        run: |
          echo "CWD=$(pwd)"
          ls -lah docs/outputs
          git status --porcelain

      - name: Commit charts if changed
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/outputs/*.png docs/outputs/*history*.csv docs/outputs/_last_run.txt || true
          git commit -m "chore(charts): update R-BANK9 long-term charts (1d/7d/1m/1y)" || echo "no changes"
          git push || true
